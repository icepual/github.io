<!DOCTYPE html>
<html lang="en">
  <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="icepual的个人博客">
  <meta name="keywords" content="icepual 博客">
  <meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="shortcut icon" href="http://selfblog-1253589063.file.myqcloud.com/common/fav.ico">
  <link rel="bookmark" href="http://selfblog-1253589063.file.myqcloud.com/common/fav.ico" />
  <title>icepual</title>
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/jquery-3.1.1.min.js"></script>
</head>

  <body>
    <div class="container">
      
<header id="header" class="header">
  <div class="header-banner"></div>
  <!-- 常规导航 -->
  <div class="header-outer" id="navBar">
    <nav class="header-nav">
      
        <a class="header-nav-link " href="/">
          首页
        </a>
        
        <a class="header-nav-link " href="/archives/">
          归档
        </a>
        
        <a class="header-nav-link " href="/categories/">
          分类
        </a>
        
        <a class="header-nav-link " href="/tags/">
          标签
        </a>
        
    </nav>
    <div class="header-nav-mobile">
      <div class="menu" id="menuMobile" isopen="false"></div>
      <div class="title">icepual</div>
      <img class="nav-head rotation" src="http://selfblog-1253589063.file.myqcloud.com/common/header_100.png">
    </div>
  </div>
  <!-- 顶部固定 -->
  <div class="header-outer fixed-nav shadow">
    <nav class="header-nav">
      
        <a class="header-nav-link " href="/">
          首页
        </a>
      
        <a class="header-nav-link " href="/archives/">
          归档
        </a>
      
        <a class="header-nav-link " href="/categories/">
          分类
        </a>
      
        <a class="header-nav-link " href="/tags/">
          标签
        </a>
      
    </nav>
  </div>
  <!-- mobile下拉列表 -->
  <nav class="header-menu-list">
    
      <a class="header-menu-list-link " href="/">
        首页
      </a>
      
      <a class="header-menu-list-link " href="/archives/">
        归档
      </a>
      
      <a class="header-menu-list-link " href="/categories/">
        分类
      </a>
      
      <a class="header-menu-list-link " href="/tags/">
        标签
      </a>
      
  </nav>
  <!-- 个人中心下拉列表 -->
  <nav class="header-info-list">
    <a href="/archives" class="header-info-list-link">
        归档（8）
    </a>
    <a href="/categories" class="header-info-list-link">
        分类（11）
    </a>
    <a href="/tags" class="header-info-list-link">
        标签（7）
    </a>
  </nav>
  <script>
    function fixHeader(){
      var touchHead = $('#navBar').offset().top - $(window).scrollTop();
      if(touchHead && touchHead <= 0){
        $('.fixed-nav').show();
      }else{
        $('.fixed-nav').hide(0);
      }
    }
    $(function() {
      // window.addEventListener('scroll', this.handleScroll);
      $(window).scroll(function (){
        fixHeader();
      });
      $('#menuMobile').click(function (){
        if($(this).hasClass('menu-close')){
          $(this).removeClass('menu-close');
          $('.header-menu-list').removeClass('open');
        }else{
          $(this).addClass('menu-close');
          $('.header-menu-list').addClass('open');
        }
      });

     /*  $('.nav-head').click(function(){
        if($(this).hasClass('close')){
          $(this).removeClass('close');
          $('.header-info-list').addClass('open');
        }else{
          $(this).addClass('close');
          $('.header-info-list').removeClass('open');
        }
      }); */
    })
  </script>
</header>
      <div class="main-wrap">
        <div class="main-left">
          <div class="main-container shadow">

    <!-- 标准post -->
    <article class="article">
  <div class="article-detail">
    
      <div class="article-cover" style="background-image:url('http://selfblog-1253589063.file.myqcloud.com/post/pngcut.png')"></div>
    
    <div class="article-title">
      node+puppeteer简单爬虫爬取图片地址
    </div>
    <div class="article-msg">
      <span class="article-time"><i class="ice ice-rili"></i> 发布时间 2018-04-24
      </span>
      &nbsp;|&nbsp;
      <span class="article-type"><i class="ice ice-wenjianjia"></i> 分类 前端 > JS</span>
    </div>
    <div class="article-content">
      <p>近期发现一个比较有意思的库Puppeteer, 这是Google官方推出维护的headless Chrome的node库, 可以通过脚本控制chrominum浏览器(无界面或者有界面)实现丰富功能. 比如用node完成爬虫功能、爬取spa代替pre-rander以完成seo的需求, web应用的自动化测试, 完成网页截图甚至生成pdf… <a id="more"></a> 以下是官方描述:</p>
<blockquote>
<p>What can I do?</p>
</blockquote>
<p>Most things that you can do manually in the browser can be done using Puppeteer! Here are a few examples to get you started:</p>
<ul>
<li>Generate screenshots and PDFs of pages.</li>
<li>Crawl a SPA and generate pre-rendered content (i.e. “SSR”).</li>
<li>Automate form submission, UI testing, keyboard input, etc.</li>
<li>Create an up-to-date, automated testing environment. Run your tests directly in the latest version of Chrome using the latest JavaScript and browser features.</li>
<li>Capture a timeline trace of your site to help diagnose performance issues.</li>
</ul>
<p>但改库只能调用自动安装的Chromium浏览器, 自动测试不能用于其他浏览器的测试,应用起来就会有些力不从心, 但对于抓取页面真心非常强大, 以下是一个使用Puppeteer抓取图片网站地址的小demo:</p>
<blockquote>
<p>1.安装nodejs,然后安装Puppoteer</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i puppeteer</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.测试截图功能, 新建example.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.icepual.com'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>: <span class="string">'example.png'</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.执行文件测试结果,会保留目标页面的一张简单的截图<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node example.js</span><br></pre></td></tr></table></figure></p>
<p>4.找到一个图片网站<a href="https://wallhalla.com/search?color=987a60" target="_blank" rel="external">https://wallhalla.com/search?color=987a60</a> ,尝试抓取部分图片,首先查看页面结构:<br><img src="http://selfblog-1253589063.file.myqcloud.com/post/puppoteer-example.png" alt="效果图"><br>这是用puppoteer的截图api做出的全网页截图, 图片应该是有懒加载,然后查看html代码结构:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"thumb-wrap"</span> <span class="attr">data-id</span>=<span class="string">"EGMglw0bfyl7"</span> <span class="attr">data-tags</span>=<span class="string">"dodge|vehicles"</span> <span class="attr">data-wh</span>=<span class="string">"2048x1536"</span> <span class="attr">data-sources</span>=<span class="string">"ZxI4JWJ,2048x1536,alphacoders"</span> <span class="attr">data-colors</span>=<span class="string">"967f62:36_74573e:20_c8b293:18_0d0b08:16_cdef45:7"</span> <span class="attr">data-faved</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/wallpaper/EGMglw0bfyl7"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">class</span>=<span class="string">"thumb-a"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/thumbs/small/e/EGMglw0bfyl7.jpg"</span> <span class="attr">data-src</span>=<span class="string">"/thumbs/small/e/EGMglw0bfyl7.jpg"</span> <span class="attr">class</span>=<span class="string">"thumb-img lazyload"</span> <span class="attr">width</span>=<span class="string">"350"</span> <span class="attr">height</span>=<span class="string">"262"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"thumb-footer-wrap -clr"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mlt-link -right"</span> <span class="attr">title</span>=<span class="string">"More Like This"</span>&gt;</span>more like this<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>这是网站每个图片单元的结构,可以看到图片的链接保存在img标签中, 此处做了懒加载处理, 最初只有data-src中的数据为准确链接,直接获取该链接即可,然后模拟点击下一页即可继续获取下一页图片地址, 以下为获取50页图片链接保存至文件例子:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">        headless: <span class="literal">true</span><span class="comment">//此处设为false可以改为有界面操作,可以查看浏览器具体动作</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://wallhalla.com/search?color=e9cd56'</span>, &#123;</span><br><span class="line">        waitUntil: <span class="string">'networkidle0'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.setViewport(&#123;</span><br><span class="line">        width: <span class="number">1920</span>,</span><br><span class="line">        height: <span class="number">1080</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 截图</span></span><br><span class="line">    <span class="comment">// await page.waitFor(3 * 1000);</span></span><br><span class="line">    <span class="comment">// await page.screenshot(&#123;path:"example1.png", fullPage: true&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// const images = await page.$$('.thumb-img');</span></span><br><span class="line">    <span class="keyword">await</span> handleData();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= <span class="number">50</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> nextBtn = <span class="keyword">await</span> page.$(<span class="string">'.random'</span>);</span><br><span class="line"></span><br><span class="line">        nextBtn.click();</span><br><span class="line">        <span class="comment">// 适当停止,防止被拉黑或封号</span></span><br><span class="line">        <span class="keyword">await</span> page.waitFor(<span class="number">3</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">await</span> handleData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> list = <span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 先声明一个用于存储爬取数据的数组</span></span><br><span class="line">            <span class="keyword">let</span> listString = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取到所有的商品元素</span></span><br><span class="line">            <span class="keyword">let</span> itemList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.thumb-img'</span>);</span><br><span class="line">            <span class="comment">// 遍历每一个元素，整理需要爬取的数据</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> itemList) &#123;</span><br><span class="line">                <span class="comment">// 将这个标签页的数据push进刚才声明的结果数组</span></span><br><span class="line">                listString = listString + <span class="string">',\n\'https://wallhalla.com/'</span> + item.dataset.src + <span class="string">'\''</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> listString;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 当前页面所有的返回给外部环境</span></span><br><span class="line">        fs.appendFile(<span class="string">'images-e9cd56.txt'</span>, list, (err) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"数据写入成功！"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>这里只是爬取几个简单的缩略图,获取大图需要做更多的操作甚至需要账号等信息</p>

    </div>
    <footer class="article-footer">
      
        <a class="article-footer-prev" href="/2018/04/24/eruda/"><i class="ice ice-shangyiye"></i><span class="ellipsis">移动端web调试工具</span></a>
      
      
        <a class="article-footer-next" href="/2018/04/23/jsGetWeek/"><span class="ellipsis">Date对象获取某天周数以及通过周数获取日期</span><i class="ice ice-xiayiye"></i></a>
      
    </footer>
  </div>
</article>

</div>
        </div>
        <div class="main-right">
            <aside class="sidebar">
  <div class="userinfo shadow">
    <div class="info-title">
        icepual
    </div>
    <div class="head-img">
        <img src="http://selfblog-1253589063.file.myqcloud.com/common/header_100.png">
    </div>
    <div class="info-sub-title">
        你才不是代码的搬运工...
    </div>
    <div class="info-links">
        <a class="ice ice-icon_github info-link" href="https://github.com/icepual" target="_blank" title="GitHub"></a>
        <a class="ice ice-coding info-link" href="https://coding.net/u/icepual" target="_blank" title="Coding"></a>
        <a class="ice ice-weibo1 info-link" href="http://weibo.com/icepual" target="_blank" title="微博"></a>
    </div>
    <div class="info-btns">
        <a href="/archives" class="info-btn">
            归档（8）
        </a>
        <a href="/categories" class="info-btn">
            分类（11）
        </a>
        <a href="/tags" class="info-btn">
            标签（7）
        </a>
    </div>
</div>
  
    <!-- 友链 -->
<div class="friends-wrap shadow">
    <div class="friends-title">
        友链
    </div>
    
        <a href="http://www.wilbur.wang" target="_blank"> wilbur[老王的故事] </a>
    
        <a href="http://www.ibluetory.com" target="_blank"> bluetory[蓝(lan)枫(xiang)] </a>
    
</div>
  
</aside>
        </div>
      </div>
      <footer class="footer">
  <div class="footer-info">
    <span class="footer-item">
      &copy;2018
      ice
    </span>
    <span class="footer-item footer-item-plus">
      Powered by <a class="powered" href="http://hexo.io/" target="_blank">Hexo</a>
    </span>
    <span class="footer-item footer-item-plus"><img class="hosted" src="http://selfblog-1253589063.file.myqcloud.com/common/coding.png"></span>
  </div>
</footer>
    </div>
  </body>
</html>